name: Deploy to NCP VM (Frontend: Nginx, Backend: FastAPI)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up SSH key
      run: |
        echo "${{ secrets.NCP_SSH_KEY }}" > key.pem
        chmod 600 key.pem

    - name: Deploy to NCP VM
      run: |
        ssh -i key.pem -o StrictHostKeyChecking=no ${{ secrets.NCP_USER }}@${{ secrets.NCP_HOST }} <<EOF
        set -e

        echo "âœ… ë°°í¬ ì‹œìž‘: Job-Navigator"
        cd ~/Job-Navigator

        echo "ðŸ”„ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°"
        git reset --hard
        git pull origin main

        echo "ðŸ“¦ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ (Nginxê°€ ì„œë¹™)"
        cd frontend
        npm install
        npm run build
        cd ..

        echo "ðŸ ë°±ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜"
        cd backend
        pip install -r requirements.txt

        echo "ðŸ” FastAPI systemd ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘"
        sudo systemctl restart jobnav-backend

        echo "âœ… ë°°í¬ ì™„ë£Œ!"
        EOF
